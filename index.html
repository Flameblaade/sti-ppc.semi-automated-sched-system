<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Scheduling System</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
    <link rel="stylesheet" href="css/schedule.css">
</head>
<body>
    <div class="app-container">
        <!-- Header from index.html -->
        <header class="header">
            <div class="logo">
                <h1>Automated Scheduling System</h1>
            </div>
            <div class="user-menu">
                <span class="user-name" id="userName">Super Admin</span>
                <span class="role-badge superadmin-badge" id="userRole">Super Admin</span>
                <a href="superadmin.html" class="dashboard-btn hidden" id="superadminDashboardBtn">
                    <i class="fas fa-crown"></i>
                    <span>Dashboard</span>
                </a>
                <a href="admin.html" class="dashboard-btn hidden" id="adminDashboardBtn">
                    <i class="fas fa-user-shield"></i>
                    <span>Admin Dashboard</span>
                </a>
                <a href="user-dashboard.html" class="dashboard-btn hidden" id="userDashboardBtn">
                    <i class="fas fa-user"></i>
                    <span>Dashboard</span>
                </a>
            </div>
        </header>

        <div class="main-content">
            <!-- Two Column Layout -->
            <div class="content-layout">
                <!-- Left Column: Add New Classes -->
                <div class="left-column">
                    <div class="form-panel">
                        <div class="panel-header">
                            <h2><i class="fas fa-plus-circle"></i> Add New Class</h2>
                        </div>
                        
                        <form id="scheduleForm">
                            <div class="form-group">
                                <label for="departmentSelect">Department</label>
                                <select id="departmentSelect" class="form-control" required>
                                    <option value="" selected disabled>Select Department</option>
                                </select>
                                <div class="form-error">Please select a department</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="facultySelect">Faculty Member</label>
                                <select id="facultySelect" class="form-control" required disabled>
                                    <option value="" selected disabled>Select Department First</option>
                                </select>
                                <div class="form-error">Please select a faculty member</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="subjectSelect">Subject/Course</label>
                                <select id="subjectSelect" class="form-control" disabled>
                                    <option value="" selected disabled>Select Faculty First</option>
                                </select>
                                <div class="form-error">Please select a subject/course</div>
                            </div>

                            <div class="form-group">
                                <label for="programSelect">Program/Strand</label>
                                <select id="programSelect" class="form-control" disabled>
                                    <option value="" selected disabled>Select Department First</option>
                                </select>
                            </div>

                            <div class="form-group" id="classTypeGroup" style="display: none;">
                                <label>Class Type</label>
                                <div class="radio-group">
                                    <label class="radio-container">
                                        <input type="radio" name="classType" value="lecture" required>
                                        <span class="radio-text">Lecture</span>
                                    </label>
                                    <label class="radio-container">
                                        <input type="radio" name="classType" value="laboratory">
                                        <span class="radio-text">Laboratory</span>
                                    </label>
                                </div>
                                <div class="form-error">Please select a class type</div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" id="submitScheduleBtn" class="btn btn-primary">
                                    <i class="fas fa-check"></i> Submit
                                </button>
                                <button type="button" id="clearFormBtn" class="btn btn-secondary">
                                    <i class="fas fa-undo"></i> Clear
                                </button>
                            </div>
                        </form>
                        
                        <!-- Classes Management -->
                        <div class="classes-section">
                            <div class="classes-actions">
                                <span class="badge" id="classesCountBadge">0</span>
                                <button type="button" id="viewCreatedClassesBtn" class="btn btn-primary" style="margin-right: auto;">
                                    <i class="fas fa-list-check"></i> View Classes
                                </button>
                                <button type="button" id="clearClassesBtn" class="btn btn-secondary">
                                    <i class="fas fa-trash-alt"></i> Clear Classes
                                </button>
                            </div>
                            
                            <div id="createdClasses" class="classes-list">
                                <div class="empty-state">
                                    <i class="fas fa-calendar-plus"></i>
                                    <h4>No classes created yet</h4>
                                    <p>Start by filling the form above to create your first class</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Class Schedule -->
                <div class="right-column">
                    <div class="schedule-panel">
                        <div class="panel-header">
                            <h2 class="panel-title">Schedule Timetable</h2>
                            <div class="panel-actions">
                                <button type="button" id="generateScheduleBtn" class="btn btn-primary">
                                    <i class="fas fa-calendar-check"></i> Generate Schedule
                                </button>
                                <button type="button" id="clearScheduleBtn" class="btn btn-secondary">
                                    <i class="fas fa-trash-alt"></i> Clear Schedule
                                </button>
                            </div>
                        </div>
                        <div class="calendar-container">
                            <div id="calendar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Clear Schedule Confirmation Modal -->
    <div id="clearScheduleModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Clear Schedule Confirmation</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-color);">
                    <strong>Warning:</strong> This action will permanently delete all schedules from the timetable. This cannot be undone.
                </p>
                <p style="margin-bottom: 20px; color: var(--dark-gray); font-size: 0.9rem;">
                    To confirm, please type <strong style="color: var(--accent-color);">"confirm"</strong> in the field below:
                </p>
                <input 
                    type="text" 
                    id="confirmClearInput" 
                    class="form-control" 
                    placeholder="Type 'confirm' to proceed"
                    autocomplete="off"
                    style="margin-bottom: 16px;"
                >
                <p id="confirmClearError" style="color: var(--accent-color); font-size: 0.85rem; margin-top: 8px; display: none;">
                    <i class="fas fa-exclamation-circle"></i> Please type "confirm" exactly to proceed.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirmClearBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-check"></i> Clear Schedule
                </button>
                <button type="button" id="cancelClearBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Clear Classes Confirmation Modal -->
    <div id="clearClassesModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Clear Classes Confirmation</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-color);">
                    <strong>Warning:</strong> This action will permanently delete all created classes from both the list and the calendar. This cannot be undone.
                </p>
                <p style="margin-bottom: 20px; color: var(--dark-gray); font-size: 0.9rem;">
                    To confirm, please type <strong style="color: var(--accent-color);">"confirm"</strong> in the field below:
                </p>
                <input 
                    type="text" 
                    id="confirmClearClassesInput" 
                    class="form-control" 
                    placeholder="Type 'confirm' to proceed"
                    autocomplete="off"
                    style="margin-bottom: 16px;"
                >
                <p id="confirmClearClassesError" style="color: var(--accent-color); font-size: 0.85rem; margin-top: 8px; display: none;">
                    <i class="fas fa-exclamation-circle"></i> Please type "confirm" exactly to proceed.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirmClearClassesBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-check"></i> Clear Classes
                </button>
                <button type="button" id="cancelClearClassesBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Created Classes Modal -->
    <div id="createdClassesModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-list-check"></i> Created Classes</h3>
                <button type="button" class="close-modal" data-close-modal="createdClassesModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Stats Section -->
                <div class="modal-stats-grid">
                    <div class="stat-card stat-card-purple">
                        <div class="stat-label">Total Classes</div>
                        <div class="stat-value" id="modalClassCount">0</div>
                    </div>
                    <div class="stat-card stat-card-pink">
                        <div class="stat-label">Total Hours</div>
                        <div class="stat-value" id="modalTotalHours">0</div>
                    </div>
                    <div class="stat-card stat-card-blue">
                        <div class="stat-label">Conflicts</div>
                        <div class="stat-value" id="modalConflictCount">0</div>
                    </div>
                </div>
                
                <!-- Classes List -->
                <div class="modal-classes-list-container">
                    <div id="modalClassesList">
                        <div class="empty-state">
                            <i class="fas fa-calendar-plus"></i>
                            <h4>No classes created yet</h4>
                            <p>Start by filling the form above to create your first class</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal" data-close-modal="createdClassesModal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Event Details Modal -->
    <div id="eventDetailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-check"></i> Event Details</h3>
                <button type="button" class="close-modal" data-close-modal="eventDetailsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="event-detail-item">
                    <label><i class="fas fa-book"></i> Subject:</label>
                    <span id="eventDetailSubject"></span>
                </div>
                <div class="event-detail-item">
                    <label><i class="fas fa-clock"></i> Time:</label>
                    <span id="eventDetailTime"></span>
                </div>
                <div class="event-detail-item">
                    <label><i class="fas fa-calendar-day"></i> Day:</label>
                    <span id="eventDetailDay"></span>
                </div>
                <div class="event-detail-item">
                    <label><i class="fas fa-building"></i> Department:</label>
                    <span id="eventDetailDepartment"></span>
                </div>
                <div class="event-detail-item">
                    <label><i class="fas fa-chalkboard-teacher"></i> Teacher:</label>
                    <span id="eventDetailTeacher"></span>
                </div>
                <div class="event-detail-item">
                    <label><i class="fas fa-door-open"></i> Room:</label>
                    <span id="eventDetailRoom"></span>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="eventRoomSelect"><i class="fas fa-exchange-alt"></i> Change Room:</label>
                    <select id="eventRoomSelect" class="form-control">
                        <option value="">Loading rooms...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveRoomBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button type="button" id="deleteEventBtn" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i> Delete Schedule
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    
    <!-- Quick check for admin dashboard button - runs immediately -->
    <script>
        // Immediate check for admin role and show button
        (function() {
            try {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const role = userData.role || 'user';
                console.log('Immediate check - Role:', role);
                
                if (role.toLowerCase() === 'admin') {
                    setTimeout(function() {
                        const adminBtn = document.getElementById('adminDashboardBtn');
                        if (adminBtn) {
                            adminBtn.classList.remove('hidden');
                            adminBtn.style.display = 'inline-flex';
                            adminBtn.style.visibility = 'visible';
                            console.log('Immediate check - Admin button shown');
                        }
                    }, 0);
                }
            } catch(e) {
                console.error('Error in immediate check:', e);
            }
        })();
    </script>
    
    <!-- Offline Support - Must load first -->
    <script src="javascript/service-worker-register.js"></script>
    <script src="javascript/offline-storage.js"></script>
    <script src="javascript/offline-sync.js"></script>
    <script src="javascript/offline-ui.js"></script>
    
    <!-- Include schedule.js functionality for calendar and data loading -->
    <script src="javascript/schedule.js"></script>
    
    <!-- Include main.js for submit button and form functionality -->
    <script src="javascript/main.js"></script>
    
    <!-- Role synchronization - automatically updates when role changes -->
    <script src="javascript/role-sync.js"></script>
    
    <!-- Final check after all scripts load -->
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const role = userData.role || 'user';
                console.log('Final check - Role:', role);
                
                if (role.toLowerCase() === 'admin') {
                    const adminBtn = document.getElementById('adminDashboardBtn');
                    if (adminBtn) {
                        adminBtn.classList.remove('hidden');
                        adminBtn.style.display = 'inline-flex';
                        adminBtn.style.visibility = 'visible';
                        adminBtn.style.opacity = '1';
                        console.log('Final check - Admin button forced visible');
                    }
                }
                
                // Also call updateUserInfo one more time
                if (typeof updateUserInfo === 'function') {
                    updateUserInfo();
                }
            }, 200);
        });
    </script>
    
    <!-- Clear Schedule Confirmation Handler -->
    <script>
        // Run after main.js has loaded
        setTimeout(function() {
            const clearScheduleBtn = document.getElementById('clearScheduleBtn');
            const clearScheduleModal = document.getElementById('clearScheduleModal');
            const confirmClearInput = document.getElementById('confirmClearInput');
            const confirmClearBtn = document.getElementById('confirmClearBtn');
            const cancelClearBtn = document.getElementById('cancelClearBtn');
            const confirmClearError = document.getElementById('confirmClearError');
            
            if (!clearScheduleBtn || !clearScheduleModal) return;
            
            // Remove any existing event listeners by cloning the button
            const newClearBtn = clearScheduleBtn.cloneNode(true);
            clearScheduleBtn.parentNode.replaceChild(newClearBtn, clearScheduleBtn);
            
            // Get reference to the new button
            const clearBtn = document.getElementById('clearScheduleBtn');
            
            // Open modal when clear schedule button is clicked
            clearBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Reset modal state
                if (confirmClearInput) confirmClearInput.value = '';
                if (confirmClearBtn) confirmClearBtn.disabled = true;
                if (confirmClearError) confirmClearError.style.display = 'none';
                
                // Show modal
                if (clearScheduleModal) {
                    clearScheduleModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    
                    // Focus on input
                    setTimeout(() => {
                        if (confirmClearInput) confirmClearInput.focus();
                    }, 100);
                }
            });
            
            // Validate input as user types
            confirmClearInput.addEventListener('input', function() {
                const value = this.value.trim().toLowerCase();
                if (value === 'confirm') {
                    confirmClearBtn.disabled = false;
                    confirmClearError.style.display = 'none';
                    this.style.borderColor = 'var(--success-color)';
                } else {
                    confirmClearBtn.disabled = true;
                    if (value.length > 0 && value !== 'confirm') {
                        confirmClearError.style.display = 'block';
                        this.style.borderColor = 'var(--accent-color)';
                    } else {
                        confirmClearError.style.display = 'none';
                        this.style.borderColor = 'var(--border-color)';
                    }
                }
            });
            
            // Handle Enter key in input
            confirmClearInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !confirmClearBtn.disabled) {
                    confirmClearBtn.click();
                }
            });
            
            // Confirm clear schedule
            confirmClearBtn.addEventListener('click', function() {
                if (confirmClearInput.value.trim().toLowerCase() !== 'confirm') {
                    return;
                }
                
                // Close modal
                clearScheduleModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // Clear schedule using the function from main.js
                if (window.clearSchedule && typeof window.clearSchedule === 'function') {
                    window.clearSchedule();
                } else if (window.calendar) {
                    // Fallback: directly clear calendar events
                    window.calendar.removeAllEvents();
                    localStorage.removeItem('calendarEvents');
                }
                
                // Show notification
                if (typeof showNotification === 'function') {
                    showNotification('All schedules have been cleared from the timetable.', 'success');
                }
                
                // Reset modal
                confirmClearInput.value = '';
                confirmClearBtn.disabled = true;
            });
            
            // Cancel button
            cancelClearBtn.addEventListener('click', function() {
                clearScheduleModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                confirmClearInput.value = '';
                confirmClearBtn.disabled = true;
                confirmClearError.style.display = 'none';
            });
            
            // Close modal when clicking outside
            clearScheduleModal.addEventListener('click', function(e) {
                if (e.target === clearScheduleModal) {
                    clearScheduleModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    confirmClearInput.value = '';
                    confirmClearBtn.disabled = true;
                    confirmClearError.style.display = 'none';
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && clearScheduleModal.style.display === 'flex') {
                    clearScheduleModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    confirmClearInput.value = '';
                    confirmClearBtn.disabled = true;
                    confirmClearError.style.display = 'none';
                }
            });
        }, 500);
    </script>
    
    <!-- Clear Classes Confirmation Handler -->
    <script>
        // Run after main.js has loaded
        setTimeout(function() {
            const clearClassesBtn = document.getElementById('clearClassesBtn');
            const clearClassesModal = document.getElementById('clearClassesModal');
            const confirmClearClassesInput = document.getElementById('confirmClearClassesInput');
            const confirmClearClassesBtn = document.getElementById('confirmClearClassesBtn');
            const cancelClearClassesBtn = document.getElementById('cancelClearClassesBtn');
            const confirmClearClassesError = document.getElementById('confirmClearClassesError');
            
            if (!clearClassesModal || !confirmClearClassesInput || !confirmClearClassesBtn) return;
            
            // Validate input as user types
            confirmClearClassesInput.addEventListener('input', function() {
                const value = this.value.trim().toLowerCase();
                if (value === 'confirm') {
                    confirmClearClassesBtn.disabled = false;
                    confirmClearClassesError.style.display = 'none';
                    this.style.borderColor = 'var(--success-color)';
                } else {
                    confirmClearClassesBtn.disabled = true;
                    if (value.length > 0 && value !== 'confirm') {
                        confirmClearClassesError.style.display = 'block';
                        this.style.borderColor = 'var(--accent-color)';
                    } else {
                        confirmClearClassesError.style.display = 'none';
                        this.style.borderColor = 'var(--border-color)';
                    }
                }
            });
            
            // Handle Enter key in input
            confirmClearClassesInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !confirmClearClassesBtn.disabled) {
                    confirmClearClassesBtn.click();
                }
            });
            
            // Confirm clear classes
            confirmClearClassesBtn.addEventListener('click', function() {
                if (confirmClearClassesInput.value.trim().toLowerCase() !== 'confirm') {
                    return;
                }
                
                // Close modal
                clearClassesModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // Clear calendar events
                if (window.calendar) {
                    window.calendar.removeAllEvents();
                }
                
                // Clear the classes list
                const classesList = document.getElementById('createdClasses');
                if (classesList) {
                    classesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-plus"></i>
                            <h4>No classes created yet</h4>
                            <p>Start by filling the form above to create your first class</p>
                        </div>
                    `;
                }
                
                // Clear using global reset to ensure internal state stays in sync
                if (typeof window.resetClasses === 'function') {
                    window.resetClasses();
                } else {
                    if (window.allClasses) {
                        window.allClasses = [];
                    }
                    localStorage.removeItem('allClasses');
                }
                
                // Update badge
                const badge = document.getElementById('classesCountBadge');
                if (badge) {
                    badge.textContent = '0';
                }
                
                // Update modal if it's open
                if (typeof updateModalClassesList === 'function') {
                    updateModalClassesList();
                }
                if (typeof updateModalStats === 'function') {
                    updateModalStats();
                }
                
                // Show notification
                if (typeof showNotification === 'function') {
                    showNotification('All classes have been cleared.', 'success');
                }
                
                // Reset modal
                confirmClearClassesInput.value = '';
                confirmClearClassesBtn.disabled = true;
            });
            
            // Cancel button
            if (cancelClearClassesBtn) {
                cancelClearClassesBtn.addEventListener('click', function() {
                    clearClassesModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    confirmClearClassesInput.value = '';
                    confirmClearClassesBtn.disabled = true;
                    confirmClearClassesError.style.display = 'none';
                });
            }
            
            // Close modal when clicking outside
            clearClassesModal.addEventListener('click', function(e) {
                if (e.target === clearClassesModal) {
                    clearClassesModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    confirmClearClassesInput.value = '';
                    confirmClearClassesBtn.disabled = true;
                    confirmClearClassesError.style.display = 'none';
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && clearClassesModal.style.display === 'flex') {
                    clearClassesModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    confirmClearClassesInput.value = '';
                    confirmClearClassesBtn.disabled = true;
                    confirmClearClassesError.style.display = 'none';
                }
            });
        }, 500);
    </script>
</body>
</html>


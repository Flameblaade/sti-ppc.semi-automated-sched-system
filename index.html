<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduling System</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.css">
    <!-- Choices.js for searchable dropdowns -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
    <link rel="stylesheet" href="css/schedule.css">
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Choices.js for searchable dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header from index.html -->
        <header class="header">
            <div class="logo">
                <h1>Scheduling System</h1>
            </div>
            <div class="user-menu">
                <span class="user-name" id="userName">Super Admin</span>
                <span class="role-badge superadmin-badge" id="userRole">Super Admin</span>
                <a href="superadmin.html" class="dashboard-btn hidden" id="superadminDashboardBtn">
                    <i class="fas fa-crown"></i>
                    <span>Dashboard</span>
                </a>
                <a href="admin.html" class="dashboard-btn hidden" id="adminDashboardBtn">
                    <i class="fas fa-user-shield"></i>
                    <span>Admin Dashboard</span>
                </a>
                <a href="user-dashboard.html" class="dashboard-btn hidden" id="userDashboardBtn">
                    <i class="fas fa-user"></i>
                    <span>Dashboard</span>
                </a>
            </div>
        </header>

        <div class="main-content">
            <!-- Two Column Layout -->
            <div class="content-layout">
                <!-- Left Column: Add New Classes -->
                <div class="left-column">
                    <div class="form-panel">
                        <div class="panel-header">
                            <h2><i class="fas fa-plus-circle"></i> Add New Class</h2>
                        </div>
                        
                        <form id="scheduleForm">
                            <div class="form-group">
                                <label for="programSelect">Program/Strand</label>
                                <select id="programSelect" class="form-control" required>
                                    <option value="" selected disabled>Select Program/Strand</option>
                                </select>
                                <div class="form-error">Please select a program/strand</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="facultySelect">Faculty Member <span style="color: #999; font-size: 12px;">(Optional for Superadmin)</span></label>
                                <select id="facultySelect" class="form-control" disabled>
                                    <option value="" selected disabled>Select Program/Strand First</option>
                                </select>
                                <div class="form-error">Please select a faculty member</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="subjectSelect">Subject/Course</label>
                                <select id="subjectSelect" class="form-control" disabled>
                                    <option value="" selected disabled>Select Program/Strand First</option>
                                </select>
                                <div id="subjectDetails" class="subject-details" style="display: none; margin-top: 10px; padding: 10px; background-color: #f0f7ff; border-left: 3px solid #4a90e2; border-radius: 4px; font-size: 0.9rem;">
                                    <div style="font-weight: 600; margin-bottom: 5px; color: #2c3e50;">
                                        <i class="fas fa-info-circle"></i> Subject Details:
                                    </div>
                                    <div id="subjectDetailsContent" style="color: #555;">
                                        <!-- Details will be populated here -->
                                    </div>
                                </div>
                                <div class="form-error">Please select a subject/course</div>
                            </div>


                            <div class="form-group" id="classTypeGroup" style="display: none;">
                                <label>Class Type</label>
                                <div class="radio-group">
                                    <label class="radio-container">
                                        <input type="radio" name="classType" value="lecture" required>
                                        <span class="radio-text">Lecture</span>
                                    </label>
                                    <label class="radio-container">
                                        <input type="radio" name="classType" value="laboratory">
                                        <span class="radio-text">Laboratory</span>
                                    </label>
                                </div>
                                <div class="form-error">Please select a class type</div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" id="submitScheduleBtn" class="btn btn-primary">
                                    <i class="fas fa-check"></i> Submit
                                </button>
                                <button type="button" id="clearFormBtn" class="btn btn-secondary">
                                    <i class="fas fa-undo"></i> Clear
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Created Classes Section -->
                    <div class="form-panel" style="margin-top: 20px;">
                        <div class="panel-header">
                            <h2><i class="fas fa-list-check"></i> Created Classes</h2>
                            <span class="badge" id="classesCountBadge">0</span>
                        </div>
                        <div style="padding: 15px;">
                            <button type="button" id="viewClassesDetailsBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                                <i class="fas fa-info-circle"></i> View Classes Details
                            </button>
                            <button type="button" id="clearClassesBtn" class="btn btn-danger" style="width: 100%; margin-bottom: 15px;">
                                <i class="fas fa-trash-alt"></i> Clear All Classes
                            </button>
                            <!-- Search Bar for Created Classes -->
                            <div style="margin-bottom: 15px; position: relative;">
                                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; z-index: 1;"></i>
                                <input type="text" id="createdClassesSearch" placeholder="Search classes..." style="
                                    width: 100%;
                                    padding: 10px 12px 10px 40px;
                                    border: 2px solid #e2e8f0;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    box-sizing: border-box;
                                    transition: border-color 0.2s ease;
                                ">
                            </div>
                            <div id="createdClasses" class="classes-list" style="max-height: 300px; overflow-y: auto;">
                                <div class="empty-state">
                                    <i class="fas fa-calendar-plus"></i>
                                    <h4>No classes created yet</h4>
                                    <p>Start by filling the form above to create your first class</p>
                                </div>
                            </div>
                            
                            <!-- Merge Classes Section -->
                            <div id="mergeClassesSection" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0; font-size: 0.95rem; color: #374151;">
                                        <i class="fas fa-link"></i> Merge Classes
                                    </h4>
                                    <button type="button" id="enableMergeModeBtn" class="btn btn-secondary btn-sm" style="padding: 6px 12px; font-size: 0.85rem;">
                                        <i class="fas fa-check-square"></i> Select to Merge
                                    </button>
                                </div>
                                <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 10px;">
                                    Select multiple classes with the same subject to merge them. Merged classes will share the same schedule.
                                </p>
                                <div id="mergeActionsContainer" style="display: none;">
                                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                                        <button type="button" id="mergeSelectedBtn" class="btn btn-primary btn-sm" style="flex: 1; padding: 8px 12px;" disabled>
                                            <i class="fas fa-link"></i> Merge Selected (<span id="mergeCount">0</span>)
                                        </button>
                                        <button type="button" id="cancelMergeBtn" class="btn btn-secondary btn-sm" style="padding: 8px 12px;">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    </div>
                                    <div id="mergeInfo" style="font-size: 0.8rem; color: #059669; padding: 8px; background: #d1fae5; border-radius: 4px; display: none;">
                                        <i class="fas fa-info-circle"></i> <span id="mergeInfoText"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Unassigned Schedules Section -->
                    <div class="form-panel" id="unassignedSchedulesPanel" style="margin-top: 20px; display: none;">
                        <div class="panel-header">
                            <h2>
                                <i class="fas fa-user-clock"></i> Unassigned Schedules
                                <span class="badge" id="unassignedCountBadge" style="margin-left: 8px;">0</span>
                            </h2>
                        </div>
                        <div style="padding: 15px;">
                            <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 15px;">
                                These schedules don't have a faculty member assigned. Select a faculty member to assign them.
                            </p>
                            <div style="margin-bottom: 15px;">
                                <label for="searchUnassignedSchedules" style="display: block; margin-bottom: 5px; font-weight: 500;">Search Schedules:</label>
                                <input type="text" id="searchUnassignedSchedules" class="form-control" placeholder="Search by subject, department, day, time, or room..." style="margin-bottom: 15px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="assignFacultySelect" style="display: block; margin-bottom: 5px; font-weight: 500;">Select Faculty Member:</label>
                                <select id="assignFacultySelect" class="form-control" style="margin-bottom: 10px;">
                                    <option value="">Select Faculty Member</option>
                                </select>
                                <button type="button" id="assignSchedulesBtn" class="btn btn-primary" style="width: 100%;" disabled>
                                    <i class="fas fa-user-check"></i> Assign Selected Schedules
                                </button>
                            </div>
                            <div id="unassignedSchedulesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px;">
                                <div class="empty-state">
                                    <i class="fas fa-check-circle"></i>
                                    <p>No unassigned schedules</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fixed Schedules Section -->
                    <div class="form-panel" style="margin-top: 20px;">
                        <div class="panel-header">
                            <h2><i class="fas fa-calendar-alt"></i> Fixed Schedules</h2>
                        </div>
                        <div style="padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; font-size: 1rem;">Existing Fixed Schedules</h4>
                                <button type="button" id="addFixedScheduleBtn" class="btn btn-primary btn-sm">
                                    <i class="fas fa-plus"></i> Add New
                                </button>
                            </div>
                            <div id="fixedSchedulesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                                <!-- Fixed schedules will be listed here -->
                            </div>
                            
                            <!-- Add Fixed Schedule Form (initially hidden) -->
                            <div id="addFixedScheduleFormContainer" style="display: none; border-top: 2px solid #e0e0e0; padding-top: 15px; margin-top: 15px;">
                                <h4 style="margin-bottom: 15px; font-size: 1rem;">Add New Fixed Schedule</h4>
                                <form id="fixedScheduleForm">
                                    <div class="form-group">
                                        <label for="fixedScheduleName">Schedule Name</label>
                                        <input type="text" id="fixedScheduleName" class="form-control" placeholder="e.g., Common Break" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="fixedScheduleDay">Day</label>
                                        <select id="fixedScheduleDay" class="form-control" required>
                                            <option value="" selected disabled>Select Day</option>
                                            <option value="Monday">Monday</option>
                                            <option value="Tuesday">Tuesday</option>
                                            <option value="Wednesday">Wednesday</option>
                                            <option value="Thursday">Thursday</option>
                                            <option value="Friday">Friday</option>
                                            <option value="Saturday">Saturday</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="fixedScheduleStartTime">Start Time</label>
                                        <input type="time" id="fixedScheduleStartTime" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="fixedScheduleEndTime">End Time</label>
                                        <input type="time" id="fixedScheduleEndTime" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="fixedScheduleAllowClasses" checked>
                                            Allow classes to be scheduled during this time
                                        </label>
                                        <small style="display: block; color: #666; margin-top: 5px;">
                                            If unchecked, classes cannot be scheduled during this fixed schedule period
                                        </small>
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" id="saveFixedScheduleBtn" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Save Schedule
                                        </button>
                                        <button type="button" id="cancelAddFixedScheduleBtn" class="btn btn-secondary">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Class Schedule -->
                <div class="right-column">
                    <div class="schedule-panel">
                        <div class="panel-header">
                            <h2 class="panel-title">Schedule Timetable</h2>
                            <div class="panel-actions">
                                <div class="schedule-backup-menu" style="position: relative; display: flex; gap: 8px;">
                                    <button type="button" id="backupScheduleBtn" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.85rem;">
                                        <i class="fas fa-download"></i> Backup
                                    </button>
                                    <button type="button" id="importScheduleBtn" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.85rem;">
                                        <i class="fas fa-upload"></i> Import
                                    </button>
                                    <input type="file" id="importScheduleFile" accept=".json" style="display: none;">
                                </div>
                                <button type="button" id="generateScheduleBtn" class="btn btn-primary">
                                    <i class="fas fa-calendar-check"></i> Generate Schedule
                                </button>
                                <button type="button" id="clearScheduleBtn" class="btn btn-secondary">
                                    <i class="fas fa-trash-alt"></i> Clear Schedule
                                </button>
                            </div>
                        </div>
                        <!-- Filter System -->
                        <div class="filter-panel">
                            <div class="filter-header">
                                <div class="filter-header-content">
                                    <i class="fas fa-filter"></i>
                                    <h3>Filter Schedule</h3>
                                </div>
                                <button type="button" id="clearFiltersBtn" class="btn-clear-filters">
                                    <i class="fas fa-times"></i>
                                    <span>Clear All</span>
                                </button>
                            </div>
                            <div class="filter-grid">
                                <div class="filter-item">
                                    <label for="filterFaculty" class="filter-label">
                                        <i class="fas fa-chalkboard-teacher"></i>
                                        <span>Faculty</span>
                                    </label>
                                    <select id="filterFaculty" class="filter-select">
                                        <option value="">All Faculty</option>
                                    </select>
                                </div>
                                <div class="filter-item">
                                    <label for="filterRoom" class="filter-label">
                                        <i class="fas fa-door-open"></i>
                                        <span>Room</span>
                                    </label>
                                    <select id="filterRoom" class="filter-select">
                                        <option value="">All Rooms</option>
                                    </select>
                                </div>
                                <div class="filter-item">
                                    <label for="filterCourse" class="filter-label">
                                        <i class="fas fa-graduation-cap"></i>
                                        <span>Course/Strand</span>
                                    </label>
                                    <select id="filterCourse" class="filter-select">
                                        <option value="">All Courses</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-status">
                                <i class="fas fa-info-circle"></i>
                                <span id="filterStatus">Showing all schedules</span>
                            </div>
                        </div>
                        <div class="calendar-container">
                            <div id="calendar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Clear Schedule Confirmation Modal -->
    <div id="clearScheduleModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Clear Schedule Confirmation</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-color);">
                    <strong>Warning:</strong> This action will permanently delete all schedules from the timetable. This cannot be undone.
                </p>
                <p style="margin-bottom: 20px; color: var(--dark-gray); font-size: 0.9rem;">
                    To confirm, please type <strong style="color: var(--accent-color);">"confirm"</strong> in the field below:
                </p>
                <input 
                    type="text" 
                    id="confirmClearInput" 
                    class="form-control" 
                    placeholder="Type 'confirm' to proceed"
                    autocomplete="off"
                    style="margin-bottom: 16px;"
                >
                <p id="confirmClearError" style="color: var(--accent-color); font-size: 0.85rem; margin-top: 8px; display: none;">
                    <i class="fas fa-exclamation-circle"></i> Please type "confirm" exactly to proceed.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirmClearBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-check"></i> Clear Schedule
                </button>
                <button type="button" id="cancelClearBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Clear Classes Confirmation Modal -->
    <div id="clearClassesModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Clear Classes Confirmation</h3>
                <button type="button" class="close-modal" data-close-modal="clearClassesModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f44336; margin-bottom: 15px;"></i>
                    <h4 style="color: #333; margin-bottom: 10px;">Are you sure?</h4>
                    <p style="color: #666; margin-bottom: 0;">
                        This action will permanently delete all created classes from both the list and the calendar. This cannot be undone.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirmClearClassesBtn" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i> Delete All Classes
                </button>
                <button type="button" id="cancelClearClassesBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Class Notification Modal -->
    <div id="classNotificationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" id="classNotificationHeader" style="background: #4caf50;">
                <h3 id="classNotificationTitle" style="color: white; margin: 0;">
                    <i class="fas fa-check-circle"></i> Success
                </h3>
                <button type="button" class="close-modal" data-close-modal="classNotificationModal" style="color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px 20px;">
                <div id="classNotificationIcon" style="font-size: 4rem; margin-bottom: 20px; color: #4caf50;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h4 id="classNotificationMessage" style="color: #333; margin-bottom: 0;">
                    Class added successfully!
                </h4>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" id="closeClassNotificationBtn" class="btn btn-primary" style="min-width: 120px;">
                    <i class="fas fa-check"></i> OK
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading Modal -->
    <div id="loadingModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-spinner fa-spin"></i> Generating Schedule</h3>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px 20px;">
                <div class="spinner" style="border: 4px solid rgba(0, 0, 0, 0.1); width: 40px; height: 40px; border-radius: 50%; border-left-color: #667eea; animation: spin 1s linear infinite; margin: 20px auto;"></div>
                <p id="scheduling-status" style="margin: 20px 0; color: #333;">Please wait while we generate your optimal schedule...</p>
                <div style="width: 100%; height: 10px; background-color: #e2e8f0; border-radius: 10px; overflow: hidden; margin: 20px 0;">
                    <div class="progress-bar" id="scheduling-progress" style="height: 100%; background-color: #667eea; transition: width 0.4s ease; width: 0%;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Conflicts Modal -->
    <div id="conflictsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: #f59e0b;">
                <h3 style="color: white; margin: 0;"><i class="fas fa-exclamation-triangle"></i> Scheduling Conflicts</h3>
                <button type="button" class="close-modal" data-close-modal="conflictsModal" style="color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p style="margin-bottom: 15px; color: #333;">The following classes couldn't be scheduled due to conflicts:</p>
                <ul id="conflictsList" style="list-style-type: none; padding-left: 0; margin: 20px 0; max-height: 300px; overflow-y: auto;">
                    <!-- Conflicts will be added here -->
                </ul>
                <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">Try reducing the number of classes or adjusting some manually.</p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn btn-primary close-modal" data-close-modal="conflictsModal" style="min-width: 120px;">
                    <i class="fas fa-check"></i> Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Fixed Schedule Confirmation Modal -->
    <div id="deleteFixedScheduleModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Delete Fixed Schedule</h3>
                <button type="button" class="close-modal" data-close-modal="deleteFixedScheduleModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f44336; margin-bottom: 15px;"></i>
                    <h4 style="color: #333; margin-bottom: 10px;">Are you sure?</h4>
                    <p style="color: #666; margin-bottom: 0;" id="deleteFixedScheduleMessage">
                        This action will permanently delete this fixed schedule. This cannot be undone.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirmDeleteFixedScheduleBtn" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
                <button type="button" id="cancelDeleteFixedScheduleBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Created Classes Details Modal -->
    <div id="createdClassesDetailsModal" class="modal" style="display: none; align-items: flex-start; padding-top: 40px;">
        <div class="modal-content" style="max-width: 800px; margin: 0 auto; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0; position: sticky; top: 0; background: white; z-index: 10; border-bottom: 1px solid #e2e8f0;">
                <h3><i class="fas fa-list-check"></i> Created Classes Details</h3>
                <button type="button" class="close-modal" data-close-modal="createdClassesDetailsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <!-- Stats Section -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white; text-align: center;">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px;">Total Classes</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="detailsTotalClasses">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 8px; color: white; text-align: center;">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px;">Total Hours</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="detailsTotalHours">0</div>
                    </div>
                </div>
                
                <!-- Search Bar -->
                <div style="margin-bottom: 20px;">
                    <input type="text" id="classesDetailsSearch" placeholder="Search by course, subject, or faculty..." style="
                        width: 100%;
                        padding: 12px 16px;
                        border: 2px solid #e2e8f0;
                        border-radius: 8px;
                        font-size: 14px;
                        box-sizing: border-box;
                    ">
                </div>
                
                <!-- Teacher Unit Loads Section -->
                <div style="margin-bottom: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden;">
                    <div class="teacher-loads-header" id="teacherLoadsHeader" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; padding: 12px 15px; transition: background-color 0.2s ease;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chevron-down teacher-loads-arrow" style="color: #2563eb; transition: transform 0.2s ease; font-size: 0.9rem;"></i>
                            <h4 style="margin: 0; color: #1e293b; font-size: 1rem;">
                                <i class="fas fa-chalkboard-teacher"></i> Teacher Unit Loads
                            </h4>
                        </div>
                        <span id="teacherLoadsCount" style="background: #2563eb; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">0</span>
                    </div>
                    <div class="teacher-loads-content" id="teacherLoadsContent" style="display: none; padding: 12px 15px; max-height: 300px; overflow-y: auto;">
                        <div id="teacherUnitLoads" style="display: flex; flex-direction: column; gap: 6px; font-size: 0.85rem;">
                            <!-- Teacher unit loads will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Classes List -->
                <div style="max-height: 400px; overflow-y: auto;">
                    <div id="createdClassesDetailsList">
                        <div class="empty-state">
                            <i class="fas fa-calendar-plus"></i>
                            <h4>No classes created yet</h4>
                            <p>Start by adding your first class</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fixed Schedule Modal (kept for backward compatibility, but will be replaced) -->
    <div id="fixedScheduleModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-alt"></i> Add Fixed Schedule</h3>
                <button type="button" class="close-modal" data-close-modal="fixedScheduleModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="fixedScheduleFormOld">
                    <div class="form-group">
                        <label for="fixedScheduleNameOld">Schedule Name</label>
                        <input type="text" id="fixedScheduleNameOld" class="form-control" placeholder="e.g., Common Break" required>
                    </div>
                    <div class="form-group">
                        <label for="fixedScheduleDayOld">Day</label>
                        <select id="fixedScheduleDayOld" class="form-control" required>
                            <option value="" selected disabled>Select Day</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fixedScheduleStartTimeOld">Start Time</label>
                        <input type="time" id="fixedScheduleStartTimeOld" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="fixedScheduleEndTimeOld">End Time</label>
                        <input type="time" id="fixedScheduleEndTimeOld" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="fixedScheduleAllowClassesOld" checked>
                            Allow classes to be scheduled during this time
                        </label>
                        <small style="display: block; color: #666; margin-top: 5px;">
                            If unchecked, classes cannot be scheduled during this fixed schedule period
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveFixedScheduleBtnOld" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Schedule
                </button>
            </div>
        </div>
    </div>
    
    <!-- Event Details Modal -->
    <div id="eventDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="eventDetailHeaderTitle"><i class="fas fa-calendar-check"></i> Event Details</h3>
                <button type="button" class="close-modal" data-close-modal="eventDetailsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 18px; max-height: 65vh; overflow-y: auto;">
                <!-- Event Information Section -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1e293b; font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-info-circle" style="color: #667eea; font-size: 0.9rem;"></i> Class Information
                    </h4>
                    <div style="background: #f8fafc; border-radius: 6px; padding: 12px; border: 1px solid #e2e8f0;">
                        <!-- Subject as Title -->
                        <div style="padding: 10px 0; border-bottom: 1px solid #e2e8f0; margin-bottom: 10px;">
                            <h3 id="eventDetailSubject" style="margin: 0; font-size: 1.1rem; font-weight: 700; color: #1e293b;"></h3>
                        </div>
                        <!-- Type (Lecture or Laboratory) -->
                        <div class="event-detail-item" style="padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                            <label style="min-width: 130px; font-size: 0.875rem;"><i class="fas fa-graduation-cap"></i> Type:</label>
                            <span id="eventDetailType" style="color: #475569; font-size: 0.875rem; font-weight: 500;"></span>
                        </div>
                        <!-- Course/Strand -->
                        <div class="event-detail-item" style="padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                            <label style="min-width: 130px; font-size: 0.875rem;"><i class="fas fa-building"></i> Course/Strand:</label>
                            <span id="eventDetailCourse" style="color: #475569; font-size: 0.875rem;"></span>
                        </div>
                        <!-- Room -->
                        <div class="event-detail-item" style="padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                            <label style="min-width: 130px; font-size: 0.875rem;"><i class="fas fa-door-open"></i> Room:</label>
                            <span id="eventDetailRoom" style="color: #475569; font-size: 0.875rem; font-weight: 600;"></span>
                        </div>
                        <!-- Faculty -->
                        <div class="event-detail-item" style="padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                            <label style="min-width: 130px; font-size: 0.875rem;"><i class="fas fa-chalkboard-teacher"></i> Faculty:</label>
                            <span id="eventDetailTeacher" style="color: #475569; font-size: 0.875rem;"></span>
                        </div>
                        <!-- Time -->
                        <div class="event-detail-item" style="padding: 10px 0;">
                            <label style="min-width: 130px; font-size: 0.875rem;"><i class="fas fa-clock"></i> Time:</label>
                            <span id="eventDetailTime" style="color: #475569; font-size: 0.875rem;"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Edit Section -->
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 10px 0; color: #1e293b; font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-edit" style="color: #667eea; font-size: 0.9rem;"></i> Edit Schedule
                    </h4>
                    
                    <div class="form-group" style="margin-bottom: 14px;">
                        <label for="eventFacultySelect" style="display: block; margin-bottom: 6px; font-weight: 500; color: #334155; font-size: 0.875rem;">
                            <i class="fas fa-user-check" style="color: #667eea; margin-right: 5px; font-size: 0.85rem;"></i> Assign Faculty Member
                        </label>
                        <select id="eventFacultySelect" class="form-control" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.875rem; transition: border-color 0.2s;">
                            <option value="">Loading faculty...</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 14px;">
                        <label for="eventRoomSelect" style="display: block; margin-bottom: 6px; font-weight: 500; color: #334155; font-size: 0.875rem;">
                            <i class="fas fa-exchange-alt" style="color: #667eea; margin-right: 5px; font-size: 0.85rem;"></i> Change Room
                        </label>
                        <select id="eventRoomSelect" class="form-control" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.875rem; transition: border-color 0.2s;">
                            <option value="">Loading rooms...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 14px 18px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; border-top: 1px solid #e2e8f0; background: #f8fafc;">
                <button type="button" id="saveFacultyBtn" class="btn btn-primary" style="min-width: 120px; padding: 8px 14px; font-size: 0.875rem;">
                    <i class="fas fa-user-check"></i> Save Faculty
                </button>
                <button type="button" id="saveRoomBtn" class="btn btn-primary" style="min-width: 120px; padding: 8px 14px; font-size: 0.875rem;">
                    <i class="fas fa-save"></i> Save Room
                </button>
                <button type="button" id="swapRoomsBtn" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-width: 120px; padding: 8px 14px; font-size: 0.875rem;">
                    <i class="fas fa-exchange-alt"></i> Swap Rooms
                </button>
                <button type="button" id="deleteEventBtn" class="btn btn-danger" style="min-width: 120px; padding: 8px 14px; font-size: 0.875rem;">
                    <i class="fas fa-trash-alt"></i> Delete Schedule
                </button>
            </div>
        </div>
    </div>
    
    <!-- Swap Rooms Modal -->
    <div id="swapRoomsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-exchange-alt"></i> Swap Rooms</h3>
                <button type="button" class="close-modal" data-close-modal="swapRoomsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 18px; max-height: 65vh; overflow-y: auto;">
                <div style="margin-bottom: 16px; padding: 12px; background: #f0f7ff; border-left: 3px solid #667eea; border-radius: 6px;">
                    <p style="margin: 0; color: #334155; font-size: 0.875rem; line-height: 1.5;">
                        <i class="fas fa-info-circle" style="color: #667eea; margin-right: 6px;"></i> Select another class at the same time to swap rooms. Both classes must be at the same time slot.
                    </p>
                </div>
                
                <div style="margin-bottom: 18px;">
                    <h4 style="margin: 0 0 10px 0; color: #1e293b; font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-calendar-check" style="color: #667eea; font-size: 0.9rem;"></i> Current Class
                    </h4>
                    <div id="currentEventInfo" style="padding: 12px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <!-- Current event info will be populated here -->
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 10px 0; color: #1e293b; font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-list" style="color: #667eea; font-size: 0.9rem;"></i> Select Class to Swap With
                    </h4>
                    <div id="swapEventsList" style="max-height: 280px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; background: #f8fafc;">
                        <div class="empty-state" style="text-align: center; padding: 20px; color: #94a3b8;">
                            <i class="fas fa-spinner fa-spin"></i> Loading events...
                        </div>
                    </div>
                    <div id="swapEventsEmpty" style="display: none; text-align: center; padding: 20px; color: #94a3b8; font-size: 0.875rem;">
                        <i class="fas fa-info-circle"></i> No other classes found at this time slot.
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 14px 18px; display: flex; justify-content: flex-end; gap: 8px; border-top: 1px solid #e2e8f0; background: #f8fafc;">
                <button type="button" id="confirmSwapRoomsBtn" class="btn btn-primary" disabled style="min-width: 120px; padding: 8px 14px; font-size: 0.875rem;">
                    <i class="fas fa-exchange-alt"></i> Swap Rooms
                </button>
                <button type="button" id="cancelSwapRoomsBtn" class="btn btn-secondary" style="min-width: 120px; padding: 8px 14px; font-size: 0.875rem;">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    
    <!-- Quick check for admin dashboard button - runs immediately -->
    <script>
        // Immediate check for admin role and show button
        (function() {
            try {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const role = userData.role || 'user';
                console.log('Immediate check - Role:', role);
                
                if (role.toLowerCase() === 'admin') {
                    setTimeout(function() {
                        const adminBtn = document.getElementById('adminDashboardBtn');
                        if (adminBtn) {
                            adminBtn.classList.remove('hidden');
                            adminBtn.style.display = 'inline-flex';
                            adminBtn.style.visibility = 'visible';
                            console.log('Immediate check - Admin button shown');
                        }
                    }, 0);
                }
            } catch(e) {
                console.error('Error in immediate check:', e);
            }
        })();
    </script>
    
    <!-- Offline Support - Must load first -->
    <script src="javascript/service-worker-register.js"></script>
    <script src="javascript/offline-storage.js"></script>
    <script src="javascript/offline-sync.js"></script>
    <script src="javascript/offline-ui.js"></script>
    
    <!-- Include schedule.js functionality for calendar and data loading -->
    <script src="javascript/schedule.js"></script>
    
    <!-- Include fixed schedules functionality -->
    <script src="javascript/fixed-schedules.js"></script>
    
    <!-- Include main.js for submit button and form functionality -->
    <script src="javascript/main.js"></script>
    
    <!-- Role synchronization - automatically updates when role changes -->
    <script src="javascript/role-sync.js"></script>
    
    <!-- Final check after all scripts load -->
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const role = userData.role || 'user';
                console.log('Final check - Role:', role);
                
                if (role.toLowerCase() === 'admin') {
                    const adminBtn = document.getElementById('adminDashboardBtn');
                    if (adminBtn) {
                        adminBtn.classList.remove('hidden');
                        adminBtn.style.display = 'inline-flex';
                        adminBtn.style.visibility = 'visible';
                        adminBtn.style.opacity = '1';
                        console.log('Final check - Admin button forced visible');
                    }
                }
                
                // Also call updateUserInfo one more time
                if (typeof updateUserInfo === 'function') {
                    updateUserInfo();
                }
            }, 200);
        });
    </script>
    
    <!-- Clear Schedule Confirmation Handler -->
    <script>
        // Run after main.js has loaded
        setTimeout(function() {
            const clearScheduleBtn = document.getElementById('clearScheduleBtn');
            const clearScheduleModal = document.getElementById('clearScheduleModal');
            const confirmClearInput = document.getElementById('confirmClearInput');
            const confirmClearBtn = document.getElementById('confirmClearBtn');
            const cancelClearBtn = document.getElementById('cancelClearBtn');
            const confirmClearError = document.getElementById('confirmClearError');
            
            if (!clearScheduleBtn || !clearScheduleModal) return;
            
            // Remove any existing event listeners by cloning the button
            const newClearBtn = clearScheduleBtn.cloneNode(true);
            clearScheduleBtn.parentNode.replaceChild(newClearBtn, clearScheduleBtn);
            
            // Get reference to the new button
            const clearBtn = document.getElementById('clearScheduleBtn');
            
            // Open modal when clear schedule button is clicked
            clearBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Reset modal state
                if (confirmClearInput) confirmClearInput.value = '';
                if (confirmClearBtn) confirmClearBtn.disabled = true;
                if (confirmClearError) confirmClearError.style.display = 'none';
                
                // Show modal
                if (clearScheduleModal) {
                    clearScheduleModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    
                    // Focus on input
                    setTimeout(() => {
                        if (confirmClearInput) confirmClearInput.focus();
                    }, 100);
                }
            });
            
            // Validate input as user types
            confirmClearInput.addEventListener('input', function() {
                const value = this.value.trim().toLowerCase();
                if (value === 'confirm') {
                    confirmClearBtn.disabled = false;
                    confirmClearError.style.display = 'none';
                    this.style.borderColor = 'var(--success-color)';
                } else {
                    confirmClearBtn.disabled = true;
                    if (value.length > 0 && value !== 'confirm') {
                        confirmClearError.style.display = 'block';
                        this.style.borderColor = 'var(--accent-color)';
                    } else {
                        confirmClearError.style.display = 'none';
                        this.style.borderColor = 'var(--border-color)';
                    }
                }
            });
            
            // Handle Enter key in input
            confirmClearInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !confirmClearBtn.disabled) {
                    confirmClearBtn.click();
                }
            });
            
            // Confirm clear schedule
            confirmClearBtn.addEventListener('click', function() {
                if (confirmClearInput.value.trim().toLowerCase() !== 'confirm') {
                    return;
                }
                
                // Close modal
                clearScheduleModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // Clear schedule using the function from main.js
                if (window.clearSchedule && typeof window.clearSchedule === 'function') {
                    window.clearSchedule();
                } else if (window.calendar) {
                    // Fallback: directly clear calendar events
                    window.calendar.removeAllEvents();
                    localStorage.removeItem('calendarEvents');
                }
                
                // Show notification
                if (typeof showNotification === 'function') {
                    showNotification('All schedules have been cleared from the timetable.', 'success');
                }
                
                // Reset modal
                confirmClearInput.value = '';
                confirmClearBtn.disabled = true;
            });
            
            // Cancel button
            cancelClearBtn.addEventListener('click', function() {
                clearScheduleModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                confirmClearInput.value = '';
                confirmClearBtn.disabled = true;
                confirmClearError.style.display = 'none';
            });
            
            // Close modal when clicking outside
            clearScheduleModal.addEventListener('click', function(e) {
                if (e.target === clearScheduleModal) {
                    clearScheduleModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    confirmClearInput.value = '';
                    confirmClearBtn.disabled = true;
                    confirmClearError.style.display = 'none';
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && clearScheduleModal.style.display === 'flex') {
                    clearScheduleModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    confirmClearInput.value = '';
                    confirmClearBtn.disabled = true;
                    confirmClearError.style.display = 'none';
                }
            });
        }, 500);
    </script>
    
    <!-- Class Notification Modal Handler -->
    <script>
        // Handle close button for class notification modal
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('classNotificationModal');
            const closeBtn = document.getElementById('closeClassNotificationBtn');
            const closeModalBtn = modal ? modal.querySelector('.close-modal[data-close-modal="classNotificationModal"]') : null;
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    if (modal) {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            }
            
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', function() {
                    if (modal) {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            }
            
            // Close on background click
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            }
        });
    </script>
    
</body>
</html>

